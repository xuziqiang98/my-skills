# 漏洞分类与审计要点（项目类型无关）

## 核心原则

- **漏洞类型与项目类型解耦**：同一漏洞类型可出现在不同项目中
- **Agent 自主判断**：不预设规则，根据代码逻辑识别漏洞
- **技术栈无关**：关注安全问题本身，而非具体 API

---

## 1. 注入类漏洞

### 1.1 命令注入

**描述**：用户可控输入被拼接到系统命令中执行

**所有项目类型**：
- Web: HTTP 参数 → shell 命令
- CLI: 命令行参数 → system()
- 嵌入式: 串口输入 → system()

**常见 Sink**：
- Python: `os.system()`, `subprocess.run(shell=True)`
- Node.js: `child_process.exec("sh -c " + input)`
- Go: `exec.Command("sh", "-c", input)`
- C: `system()`, `popen()`

**审计要点**：
- [ ] 参数是否来自不可信输入？
- [ ] 是否使用 shell=True/False？
- [ ] 是否有字符过滤？是否可绕过？

### 1.2 代码注入

**描述**：用户可控输入被当作代码执行

**所有项目类型**：
- Web: `eval(user_input)`
- 智能合约: `assembly{...}`

**常见 Sink**：
- Python: `eval()`, `exec()`, `compile()`
- JavaScript: `eval()`, `new Function()`, `setTimeout()`
- Lua: `load()`, `loadstring()`

**审计要点**：
- [ ] 是否有动态代码执行？
- [ ] 执行输入是否可控？

### 1.3 SQL 注入

**描述**：SQL 查询中拼接用户输入

**常见 Sink**：
- Python: `cursor.execute(f"SELECT * FROM {table}")`
- Java: `Statement.executeQuery(sql)`
- ORM: `raw()`, `query()`

**审计要点**：
- [ ] 是否使用参数化查询？
- [ ] 表名/列名是否动态拼接？

### 1.4 XSS

**描述**：未转义的用户输入被渲染为 HTML/JS

**常见 Sink**：
- JavaScript: `innerHTML = userInput`
- Python: `render_template_string(user_input)`

**审计要点**：
- [ ] 输出是否转义？
- [ ] 是否使用安全 API？

### 1.5 SSRF

**描述**：服务端请求用户指定的 URL

**常见 Sink**：
- Python: `requests.get(user_url)`
- Java: `new URL(user_input).openConnection()`

**审计要点**：
- [ ] 目标 URL 是否验证？
- [ ] 是否限制内网访问？

---

## 2. 认证授权类

### 2.1 认证绕过

**描述**：可以绕过身份验证机制

| 项目类型 | 常见问题 |
|----------|----------|
| Web | 中间件未应用、跳过检查 |
| API | Token 验证可绕过 |
| CLI | OS 级别认证缺失 |
| 智能合约 | `tx.origin` 误用 |

**审计要点**：
- [ ] 认证函数是否所有路径都调用？
- [ ] 是否有默认通过逻辑？

### 2.2 越权访问

**描述**：可以访问他人资源或执行他人操作

| 项目类型 | 关注点 |
|----------|--------|
| Web/API | 资源 ID 可预测、缺少 owner 检查 |
| 智能合约 | 缺少 AccessControl |
| 嵌入式 | 调试接口未禁用 |

**审计要点**：
- [ ] 操作前是否检查权限？
- [ ] 是否验证资源归属？

### 2.3 会话管理

**描述**：会话/Token 管理缺陷

**常见问题**：
- Session 固定攻击
- Token 可预测
- 登出不失效

**审计要点**：
- [ ] 登录是否重置 Session ID？
- [ ] Token 熵是否足够？

---

## 3. 数据处理类

### 3.1 反序列化

**描述**：反序列化不受信任的数据

| 项目类型 | 常见 Sink |
|----------|----------|
| Web | pickle.load, yaml.load |
| Java | ObjectInputStream.readObject |
| 智能合约 | abi.decode |

**审计要点**：
- [ ] 是否有类型白名单？
- [ ] 是否有签名验证？

### 3.2 路径穿越

**描述**：用户输入控制文件路径

**常见 Sink**：
- Python: `open(user_path, 'w')`
- Node.js: `fs.writeFile(user_path)`
- C: `fopen(user_path, "w")`

**审计要点**：
- [ ] 路径是否在允许目录内？
- [ ] 是否过滤 `..`？

### 3.3 格式化字符串

**描述**：用户输入作为格式化参数

**常见 Sink**：
- C: `printf(user_input)`, `syslog()`
- Python: `print(f"{user_input}")`
- Go: `fmt.Printf(userInput)`

**审计要点**：
- [ ] 是否使用占位符？
- [ ] 日志是否过滤敏感信息？

---

## 4. 内存安全类（嵌入式/系统级）

### 4.1 缓冲区溢出

**描述**：向固定大小缓冲区写入超长数据

**常见 Sink**：
- C: `strcpy()`, `gets()`, `sprintf()`
- Rust (unsafe): `slice::copy()`

**审计要点**：
- [ ] 是否使用安全版本 API？
- [ ] 是否有边界检查？

### 4.2 Use-After-Free

**描述**：释放后继续使用内存

**常见场景**：
- C/C++: `free()` 后继续使用
- Rust: `Box::leak()` 后使用

**审计要点**：
- [ ] 指针生命周期管理
- [ ] 是否有 use-after-free 路径

### 4.3 空指针解引用

**描述**：解引用 NULL 指针

**审计要点**：
- [ ] 是否有空指针检查？
- [ ] 错误处理是否完整？

---

## 5. 智能合约安全

### 5.1 重入攻击

**描述**：合约调用前状态未更新，导致循环调用

**审计要点**：
- [ ] 是否有 Checks-Effects-Interactions 模式？
- [ ] 是否使用 reentrancyGuard？

### 5.2 整数溢出

**描述**：算术操作超出类型范围

**审计要点**：
- [ ] 是否使用 SafeMath/checked？
- [ ] 是否检查边界？

### 5.3 访问控制

**描述**：函数缺少权限修饰符

**审计要点**：
- [ ] 关键函数是否有 onlyOwner？
- [ ] 是否正确使用 AccessControl？

---

## 6. 加密安全类

### 6.1 弱加密

**描述**：使用不安全的加密算法

**常见问题**：
- 密码存储：MD5、SHA1
- 对称加密：DES、3DES
- 模式：ECB

**审计要点**：
- [ ] 密码存储用什么算法？
- [ ] 对称加密用什么算法？

### 6.2 密钥管理

**描述**：密钥管理不当

**常见问题**：
- 密钥硬编码
- 密钥泄露
- 密钥重用

**审计要点**：
- [ ] 密钥是否来自配置/环境？
- [ ] 密钥是否版本控制？

---

## 7. 业务逻辑类

### 7.1 条件竞争

**描述**：并发操作导致状态不一致

| 项目类型 | 场景 |
|----------|------|
| Web | 并发下单 |
| 智能合约 | DAO 攻击 |
| 嵌入式 | 中断竞争 |

**审计要点**：
- [ ] 关键操作是否加锁？
- [ ] 事务是否正确？

### 7.2 流程绕过

**描述**：跳过业务流程中的检查

**常见场景**：
- 跳过验证码
- 跳过实名认证
- 状态机漏洞

**审计要点**：
- [ ] 后端是否重复校验？
- [ ] 状态转换是否验证？

### 7.3 业务规则

**描述**：业务规则实现错误

**常见场景**：
- 金额计算错误
- 限购绕过
- 积分篡改

**审计要点**：
- [ ] 数值计算是否精确？
- [ ] 边界条件是否检查？

---

## 8. 供应链安全

### 8.1 依赖漏洞

**描述**：使用有漏洞的第三方依赖

**审计要点**：
- [ ] 依赖是否定期更新？
- [ ] 是否有依赖扫描？

### 8.2 投毒

**描述**：依赖被恶意篡改

**常见场景**：
- Typosquatting
- Dependency Confusion

**审计要点**：
- [ ] 依赖来源是否验证？
- [ ] 是否有完整性校验？

---

## 9. 信息泄露类

### 9.1 硬编码 secrets

**描述**：敏感信息硬编码

**审计要点**：
- [ ] 是否有 secrets 扫描？
- [ ] 敏感信息是否入配置？

### 9.2 错误信息泄露

**描述**：错误信息暴露敏感细节

**审计要点**：
- [ ] 生产环境是否关闭调试？
- [ ] 错误是否返回敏感信息？

---

## 严重性评估矩阵

| 漏洞类型 | 利用条件 | 严重性 |
|---------|----------|--------|
| 命令注入 | 直接可利用 | Critical |
| 代码注入 | 直接可利用 | Critical |
| SQL 注入 | 直接可利用 | Critical |
| 反序列化 | 可远程利用 | Critical |
| 智能合约重入 | 直接可利用 | Critical |
| 认证绕过 | 无需任何权限 | Critical |
| 缓冲区溢出 | 可远程利用 | Critical |
| 越权访问 | 可访问他人数据 | High |
| 存储型 XSS | 可窃取 cookie | High |
| SSRF | 可探测内网 | High |
| 反射型 XSS | 需要用户交互 | Medium |
| 路径穿越 | 需要特定条件 | Medium |
| 弱加密 | 非敏感数据 | Low |
| 信息泄露 | 有限影响 | Low |
