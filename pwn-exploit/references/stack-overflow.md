# Stack Overflow Exploitation

Stack overflow is a classic memory corruption vulnerability where writing past the bounds of a buffer on the stack overwrites adjacent memory, including return addresses, saved base pointers, or local variables.

## Table of Contents

- [Basic Concepts](#basic-concepts)
- [Basic ROP](#basic-rop)
- [Advanced ROP](#advanced-rop)
- [Fancy Techniques](#fancy-techniques)

## Basic Concepts

### 栈介绍 (Stack Introduction)

Understanding stack structure, function call conventions, and stack frame layout.

**Topics:**
- Stack memory organization (high address at bottom, low address at top)
- Function prologue and epilogue
- Stack frames and their components (saved EBP, return address, local variables, arguments)
- x86/x64 calling conventions

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/stack-intro/

### 栈溢出原理 (Stack Overflow Principles)

How stack overflow vulnerabilities occur and the basics of exploitation.

**Topics:**
- Unsafe string functions (gets, strcpy, sprintf, etc.)
- Buffer overflow mechanics
- Overwriting the return address
- Simple ret2text attacks
- Control flow hijacking basics

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/stackoverflow-basic/

## Basic ROP

### 基本ROP (Basic ROP)

Return-Oriented Programming for NX (No-Execute) bypass.

**Topics:**
- ROP fundamentals: chaining existing code snippets
- ret2plt: returning to PLT entries
- ret2libc: calling libc functions
- Finding ROP gadgets (with ROPgadget)
- Constructing ROP chains

**Prerequisites:**
- Binary has NX protection enabled
- Need to find gadgets ending in `ret` or `jmp rsp`

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/basic-rop/

## Advanced ROP

### 中级ROP (Medium ROP)

More complex ROP techniques and bypasses.

**Topics:**
- ret2csu: using `__libc_csu_init` for arbitrary function calls
- Bypassing stack alignment requirements (e.g., System V AMD64 ABI)
- Dynamic linking and GOT/PLT understanding
- Advanced ROP chain construction

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/medium-rop/

### Advanced ROP Techniques

### ret2dlresolve

Exploiting the dynamic linker resolver to execute arbitrary functions without libc leaks.

**Topics:**
- Delayed binding mechanism
- PLT/GOT internals
- Forging ELF structures (link_map, Elf32_Sym, Elf32_Rela)
- Calling arbitrary functions in libc

**Advantages:**
- No libc leak required
- Works when no easy leak primitive
- Bypasses PIE and ASLR limitations

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/ret2dlresolve/

### ret2VDSO

Exploiting Virtual Dynamic Shared Object to gain code execution.

**Topics:**
- What is VDSO
- Finding VDSO base address
- Using VDSO gadgets for ROP
- Practical exploitation scenarios

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/ret2vdso/

### SROP (Sigreturn Oriented Programming)

Using sigreturn system call to set arbitrary register values.

**Topics:**
- Signal handling internals
- `rt_sigreturn` system call
- Building fake signal frames
- Setting all registers with one syscall

**Requirements:**
- `sigreturn` gadget available (usually `int 0x80` + `ret`)
- Can trigger a signal or find syscall gadget

**Use Cases:**
- Bypassing gadget limitations
- Performing full ROP with minimal gadgets
- Shellcode injection

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/advanced-rop/srop/

## Fancy Techniques

### 花式栈溢出技巧 (Fancy Stack Overflow)

Advanced and creative stack overflow exploitation methods.

**Topics:**
- Stack pivot (ret to stack pivot gadget)
- Overlapping chunks to achieve arbitrary writes
- Partial overwrites for ASLR bypass
- Ret2esp/ret2esp
- Frame pointer overwriting
- Using function arguments from stack

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/stackoverflow/x86/fancy-rop/

## Common Stack Overflow Payloads

### Basic Shellcode (No NX)

```python
payload = b'A' * offset + p32(shellcode_address) + shellcode
```

### ret2libc (NX enabled)

```python
payload = b'A' * offset
payload += p32(puts_plt)      # Call puts to leak libc
payload += p32(main)          # Return to main for second stage
payload += p32(puts_got)      # Address to print

# After leak, calculate system and /bin/sh addresses
payload2 = b'A' * offset
payload2 += p32(system)       # Call system
payload2 += p32(0)           # Return address (padding)
payload2 += p32(bin_sh)       # Argument: "/bin/sh"
```

### ROP Chain (gadgets only)

```python
payload = b'A' * offset
payload += p32(pop_edi_ret)   # gadget: pop edi; ret
payload += p32(target_value)   # Set edi
payload += p32(pop_esi_ret)   # gadget: pop esi; ret
payload += p32(0)            # Set esi
payload += p32(function_plt)   # Call function
```

## Bypassing Mitigations

| Mitigation | Bypass Technique |
|------------|-----------------|
| NX (No-Execute) | ROP, ret2libc, ret2dlresolve |
| ASLR | Information leak (puts, printf), ret2plt |
| PIE | Leak binary base, use relative offsets |
| Stack Canary | Brute force (if weak), format string leak, UAF |

## Further Resources

- **CTF-Wiki Stack Overflow:** Complete documentation with examples
- **pwntools ROP:** `from pwn import ROP; rop = ROP(binary)`
- **ROPgadget:** Find ROP gadgets: `ROPgadget --binary ./target`
