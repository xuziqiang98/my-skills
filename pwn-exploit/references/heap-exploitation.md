# Heap Exploitation

Heap exploitation targets vulnerabilities in dynamic memory allocation (malloc/free) and related operations. Techniques range from simple overflows to sophisticated "House of" attacks.

## Table of Contents

- [Ptmalloc2 Fundamentals](#ptmalloc2-fundamentals)
- [Basic Heap Attacks](#basic-heap-attacks)
- [Advanced Heap Attacks](#advanced-heap-attacks)
- [House of Techniques](#house-of-techniques)

## Ptmalloc2 Fundamentals

### 堆利用 (Heap Exploitation Introduction)

Understanding heap exploitation landscape and attack vectors.

**Topics:**
- Heap vs stack differences
- glibc malloc implementation overview
- Common heap vulnerability classes
- Exploitation challenges in modern glibc

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/introduction/

### 堆概述 (Heap Overview)

General heap concepts and structure.

**Topics:**
- Memory segments (heap, bss, data, text)
- Heap growth direction
- Chunk management and allocation
- Freed chunk management
- Memory fragmentation

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/heap-overview/

### 堆相关数据结构 (Heap Data Structures)

Understanding internal ptmalloc2 data structures.

**Topics:**
- **Chunk structure**: prev_size, size, fd, bk pointers
- **Bins**: fastbins, small bins, large bins, unsorted bin, tcache
- **malloc_state**: arena management, top chunk
- **malloc_chunk**: in-use vs free chunk layout

**Chunk Structure (glibc 2.31+):**
```
+-------------------+
| prev_size (4B)   | Only used if PREV_INUSE = 0
+-------------------+
| size (4B)         | Including flags: PREV_INUSE, IS_MMAPPED, NON_MAIN_ARENA
+-------------------+
| fd (8B)           | Forward pointer (free chunks only)
+-------------------+
| bk (8B)           | Backward pointer (free chunks only)
+-------------------+
| ...               | User data
```

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/heap-structure/

### Ptmalloc2 Implementation

#### 深入理解Ptmalloc2 (Deep Understanding)

Comprehensive ptmalloc2 internals.

**Topics:**
- Memory allocation algorithm
- Bin management
- Chunk splitting and coalescing
- Thread caching (tcache)

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/implementation/overview/

#### 基础操作 (Basic Operations)

Core malloc/free operations.

**Topics:**
- `malloc()`: Finding suitable chunk, splitting
- `free()`: Adding to bins, coalescing
- `realloc()`: Reallocation strategies
- `calloc()`: Zero-initialized allocation

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/implementation/basic/

#### 堆初始化 (Heap Initialization)

How heap is set up in process.

**Topics:**
- Main arena initialization
- Initial heap layout
- Top chunk establishment

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/implementation/heap-init/

#### 申请内存块 (Malloc Operation)

Detailed malloc implementation.

**Topics:**
- Finding appropriate bin
- Splitting large chunks
- Request size rounding
- Mmap for large allocations

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/implementation/malloc/

#### 释放内存块 (Free Operation)

Detailed free implementation.

**Topics:**
- Fastbin operations
- Unsorted bin insertion
- Chunk consolidation (coalescing)
- Handling top chunk

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/implementation/free/

#### tcache (Thread Cache)

Thread-local caching for performance.

**Topics:**
- Per-thread tcache structure
- tcache chunk layout (different from normal chunks)
- tcache poisoning attacks
- glibc 2.26+ changes

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/implementation/tcache/

#### malloc_state相关函数 (Arena Management)

Arena structure and management.

**Topics:**
- Main arena vs thread arenas
- malloc_state structure
- Locking mechanisms

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/implementation/malloc-state/

## Basic Heap Attacks

### 堆溢出 (Heap Overflow)

Buffer overflow on heap chunks.

**Topics:**
- Overflowing chunk boundaries
- Overwriting adjacent chunk headers
- Basic corruption patterns
- Detection and exploitation

**Vulnerable Code:**
```c
char *a = malloc(0x20);
char *b = malloc(0x20);
strcpy(a, user_input);  // Overflow from a into b's header
```

**Attack Flow:**
1. Overwrite size of adjacent chunk
2. Cause free() or malloc() to corrupt
3. Trigger allocation to controlled address

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/heapoverflow-basic/

### 堆中的Off-By-One (Off-By-One)

One-byte overflow in heap operations.

**Topics:**
- Common off-by-one patterns (size = user_len)
- Effect on chunk size field
- Preserving in-use bit
- Exploitation techniques

**Classic Off-By-One:**
```c
char *a = malloc(0x20);
char *b = malloc(0x20);
read(0, a, 0x21);  // Read 1 byte too many
```

**Impact:**
- Overwrite size LSB of next chunk
- Can cause overlap or unsorted bin attack
- Critical when combined with null-byte off-by-one

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/off-by-one/

### Chunk Extend and Overlapping

Extending or overlapping heap chunks.

**Topics:**
- Extending chunk size to overlap
- Overlapping in-use and free chunks
- Double allocation
- Reading/writing arbitrary heap memory

**Chunk Extend:**
1. Overflow into size field of next chunk
2. Set size to overlap with following chunks
3. Free and reallocate to control overlapped area

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/chunk-extend-overlapping/

### Unlink

Classic unlink attack (deprecated but still relevant).

**Topics:**
- Bin list corruption
- Unlink macro vulnerability
- FD = P->fd, BK = P->bk
- Write 4 bytes at arbitrary address

**Requirements:**
- glibc < 2.28 (before hardening)
- Control over both fd and bk pointers
- Known address to write

**Attack:**
```
P->fd = target - 12
P->bk = write_value - 8
free(P) → *target = write_value
```

**Mitigation:**
- glibc 2.28+: Checks `fd->bk == P` and `bk->fd == P`

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/unlink/

### Use After Free (UAF)

Using freed chunks that still have references.

**Topics:**
- Dangling pointers
- Heap metadata corruption after free
- Leveraging freed chunks
- fastbin UAF

**UAF Pattern:**
```c
char *ptr = malloc(0x20);
free(ptr);
ptr[0] = 'A';  // UAF - writing to freed chunk
```

**Exploitation:**
1. Allocate new chunk after UAF
2. Control freed chunk's fd pointer
3. Fastbin or unsorted bin attack
4. Overwrite GOT or other targets

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/use-after-free/

## Advanced Heap Attacks

### Fastbin Attack

Corrupting fastbin lists.

**Topics:**
- Fastbin structure (LIFO, single-linked list)
- Fastbin size restrictions
- Size validation checks
- Attacking free() or malloc()

**Fastbin Attack Flow:**
1. UAF or overflow to modify fd pointer
2. Point fd to fake chunk or target address
3. Allocate from fastbin to get controlled chunk
4. Write to target address (e.g., GOT)

**Constraints:**
- Chunk size must match fastbin bin size
- Size field at fake chunk must be valid
- Bypass fastbin size checks

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/fastbin-attack/

### Unsorted Bin Attack

Corrupting unsorted bin for arbitrary write.

**Topics:**
- Unsorted bin behavior (FIFO)
- bk pointer corruption
- Unsorted bin attack on malloc
- Address bypass techniques

**Attack:**
1. Unsorted bin chunk with UAF/overflow
2. Modify bk pointer to target - 0x10
3. Trigger allocation from unsorted bin
4. Write target chunk size to arbitrary address

**Use Case:**
- Overwrite global variables (e.g., `__malloc_hook`)
- Modify heap management pointers
- In glibc 2.23-2.29

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/unsorted-bin-attack/

### Large Bin Attack

Corrupting large bin for arbitrary write.

**Topics:**
- Large bin structure (sorted by size)
- fd_nextsize and bk_nextsize pointers
- Writing to arbitrary address
- More complex than unsorted bin attack

**Attack Flow:**
1. Create large bin chunks
2. UAF to corrupt pointers
3. Trigger insertion into large bin
4. Write to arbitrary address through corruption

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/large-bin-attack/

### Tcache Attack

Attacking thread-local cache (glibc 2.26+).

**Topics:**
- Tcache structure (per-thread, LIFO)
- Count limit (7 per size in 2.26-2.31)
- Weak validation (no double-free check in 2.26-2.28)
- Tcache poisoning

**Tcache Attack Techniques:**
1. **Double free**: Free same chunk twice (2.26-2.29)
2. **Poison**: Modify fd/bk pointers via UAF
3. **Arbitrary alloc**: Allocate chunk at controlled address

**Example:**
```python
# Tcache double free (2.26-2.29)
a = malloc(0x20)
free(a)
free(a)  # Double free succeeds

# Poison: Allocate a, set fd to target
b = malloc(0x20)  # Gets chunk a
b[0] = target_address  # Overwrite fd pointer
free(b)  # Adds fake chunk to tcache

# Allocate to get controlled chunk
c = malloc(0x20)  # Gets chunk b
d = malloc(0x20)  # Gets fake chunk at target_address
```

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/tcache-attack/

## House of Techniques

### House of Einherjar

Heap overlap and arbitrary allocation technique.

**Topics:**
- Creating fake chunk in previous chunk
- Null-byte off-by-one exploitation
- Overlapping chunks technique
- Named after Norse mythology

**Attack:**
1. Null-byte off-by-one to shrink chunk size
2. Free adjacent chunk
3. Overlap with allocated chunk
4. Allocate overlapped area for arbitrary write

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/house-of-einherjar/

### House of Force

Controlling malloc to return arbitrary address.

**Topics:**
- Overwriting top chunk size
- Setting huge size for top chunk
- Malloc returns near any address
- Limited by integer overflow

**Attack:**
1. Overflow to modify top chunk size
2. Set size to very large value (e.g., -1)
3. Calculate offset to target address
4. Malloc until reaching target

**Requirements:**
- Overflow into top chunk
- Ability to free top chunk (not in 2.29+)

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/house-of-force/

### House of Lore

Small bin corruption for arbitrary allocation.

**Topics:**
- Small bin structure (double-linked list)
- Corrupting small bin pointers
- Allocating at controlled address
- Limited by size validation

**Attack:**
1. Free chunk into small bin
2. Corrupt fd/bk pointers via UAF
3. Set fd to fake chunk
4. Allocate to get fake chunk

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/house-of-lore/

### House of Orange

Exploiting uninitialized top chunk.

**Topics:**
- Uninitialized top chunk at program start
- House of Orange on free()
- Getting libc leak
- Triggering unsorted bin insertion

**Attack Flow:**
1. Allocate and free to initialize heap
2. Overflow top chunk size
3. Free to trigger heap consolidation
4. Leak libc address via unsorted bin
5. Attack malloc/free hooks or other targets

**Requirements:**
- No heap allocation before exploit
- Can modify top chunk via overflow

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/house-of-orange/

### House of Rabbit

Fastbin attack variant for arbitrary allocation.

**Topics:**
- Fastbin corruption
- Creating fake fastbin chunk
- Size bypassing techniques
- Fastbin attack enhancement

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/house-of-rabbit/

### House of Roman

Advanced technique for shell execution with limited control.

**Topics:**
- Combining multiple primitives
- System call orchestration
- House of Pig variant
- Complex exploitation scenarios

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/house-of-roman/

### House of Pig

Multiple technique combination for advanced exploitation.

**Topics:**
- Mixing heap attacks
- Complex payload construction
- Bypassing multiple mitigations
- Advanced scenarios

**CTF Wiki:** https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/house-of-pig/

## Common Heap Attack Primitives

### Arbitrary Read

- **Leak libc**: `__malloc_hook`, `__free_hook` addresses in unsorted bin
- **Leak heap**: Free chunk's fd/bk pointers
- **Leak stack**: Overwrite saved pointer, print it

### Arbitrary Write

- **Fastbin attack**: Get chunk at arbitrary address
- **Unsorted bin attack**: Write size to arbitrary address (limited)
- **Large bin attack**: Write to arbitrary address
- **Tcache poisoning**: Allocate at controlled address
- **House of Force**: Malloc returns controlled address

### Hijack Execution Flow

- **Hook overwrites**: `__malloc_hook`, `__free_hook`, `__realloc_hook`
- **GOT overwrites**: Overwrite function pointers in GOT
- **IO_FILE attacks**: Overwrite FILE vtable pointers

## Heap Mitigation Bypass

| Mitigation | Bypass Technique |
|------------|-----------------|
| tcache double-free check (2.30+) | tcache poisoning, House of Orange |
| Safe-linking in fastbins (2.32+) | Unsorted bin attack, House of Orange |
| malloc_hook/free_hook removed (2.34+) | IO_FILE attacks, one_gadget |
| Strict size checks | Overlapping chunks, House of Einherjar |
| Safe-linking fd masking | Unsorted bin, large bin attacks |

## Further Resources

- **Heap Exploitation Book:** "The Heap Book" by how2heap
- **how2heap:** GitHub repository with all heap techniques
- **glibc source:** Understanding allocator internals
- **pwntools heap debugging:** `heap()` command in GDB via pwndbg
